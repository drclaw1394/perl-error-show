=head1 NAME

Error::Show - Show context and splain syntax errors and exceptions

=head1 SYNOPSIS

From the command line changes an error like this:

  ->perl examples/file_syn_error1.pl              
  "use" not allowed in expression at examples/file_syn_error1.pl line 9, at end of line
  syntax error at examples/file_syn_error1.pl line 9, near "adf
  use Socket"
  Execution of examples/file_syn_error1.pl aborted due to compilation errors.


To something a little more helpful, with no source modifications:

  ->perl  -MError::Show examples/file_syn_error1.pl
  examples/file_syn_error1.pl

   4   my $time=time;
   5   for(1..1000){
   6   	print "$_\n";
   7   }
   8   adf
   9=> use Socket;
  10   
  11   print "this will never work";

  "use" not allowed in expression at examples/file_syn_error1.pl line 9, at end of line
  syntax error at examples/file_syn_error1.pl line 9, near "adf
  use Socket"
  examples/file_syn_error1.pl had compilation errors.
  


To only perform a syntax check, use the -c flag like normal.  To enable showing
context for warnings during a check, add the warn options 

	perl -MError::Show -c examples/file_syn_error1.pl 

	perl -MError::Show=warn -c -w examples/file_syn_error1.pl 

Honours -I flags as you would expect to allow user include paths:

	perl -I my_lib -MError::Show -MAnother::Module  path/to/file.pl



Use at runtime to supplement exception handling:

  use Error::Show;

  #an die caught in a try/eval triggers an exception

  #No argument uses $@ as error
  say STDERR Error::Show;     

  #or a single exception argument of your choosing
  say STDERR Error::Show $@;  

  #Or customise the report format, line, program information
  say STDERR Error::Show line=>123, ... , error=>$e;


Generate context for your stack traces with L<Exception::Class::Base>:

  #supports no argument ($@), single argument or option pairs as
  #Error::Show::context does
  say STDERR Error::Show::tracer error=>$e;

Or supply a L<Devel::StackTrace> object directly 

  say STDERR Error::Show::tracer trace=>$my trace;
    


=head1 DESCRIPTION

From the command line, this module transparently executes your syntactically
correct code. In the case of a syntax error, it extracts context (lines of
code) surrounding the source of the (first) syntax error. The nicely formated
context is dumped on STDERR for you to see the error or your ways. 

From withing a program at runtime, it can be used to give the same formated
code context around the source of an exception and any associated stack traces.

The context information generated can be though of as an expanded stack trace.
Instead of just the function name and location generated in a normal stack
trace, the actual lines of code surrounding the execption/error are also
numberd and marked, ready for diagnosis. If the splain option is enabled, it
will also output the much more descriptive reason for the error or warning.

A handful of options provided basic configuration of how many lines of code to
print before and after the error line, indenting of stack trace context, etc.

No symbols are exported and as such they must be accesses via the package name.

B<Note:> This B<is not> an exception base class, but is designed to operate
with some popular classes on CPAN along side of normal perl error strings.

but can operate with object
exceptions as well as perl error strings.  The only requirement is the
exception object responds to stringifcation and has a C<file> and C<line>
method. A C<trace> method (returning a L<Devel::StackTrace> object is also
required for the C<Error::Show::trace> function to work as intended.


=head1 WHY USE THIS MODULE?

=over

=item 1. Small and Simple

L<Perl::Critic> is a fine tool. But it is large and complex and is focused on
your style and not syntax errors. Perl obviously tells you about syntax errors,
but this module makes it a little nicer to visualise.


=item 2. Reports syntax errors, without adding dependencies

This module can provide context information on syntax error directly from the
command line without adding a dependency to your code. It also does not require
any Exception modules to operate. 


=item 3. Doesn't force a philosophy

Equally important, this module doesn't get in the way of using nice exception
classes during run time. It supplements them. You can choose when to use it to
aid in debugging or error reporting.

=back

=head1 USAGE

=head2 Command Line usage (Syntax checking)

	perl -MError::Show  [options] file.pl 

When included in a command line switch to perl C<-MError::Show>, it syntax
checks the input program. If the syntax is OK, normal execution continues.
Otherwise detailed code context surrounding the source of the error is
generated and printed on STDERR.

B<NOTE:>It is important that it's the first C<-M> switch.

Additional C<@INC> directories and perl switches can also be used as per
normal.

The -c -I flags are honoured when the script is being checked internally, to
give as transparent as possible script checking before executing.

B<Syntax Checking Options>

The following options can be used in isolation or together

=head4 clean

If you prefer just the code context without the perl error, add the clean
option:

  perl -MError::Show=clean file.pl

=head4 warn

Instead of showing context around the first error, this options enables
displaying context around the first compile time warning found.

  perl -MError::Show=warn file.pl


=head4 splain

Runs the output through the splain program (see L<diagnostics>), giving reasons
behind the error or warning

  perl -MError::Show=splain file.pl


=head2 Exception (in program) Usage

Simply bring L<Error::Show> into your program with a use statement:

  use Error::Show;

It provides two subroutines for processing errors and exceptions.

=head3 Error::Show::context

  my $context=Error::Show::context;                     (1)
  my $context=Error::Show::context $error;              (2)
	my $context=Error::Show::context option_pairs, ...;   (3)
	
Takes an error string, or exception object and extracts the code surrounding
the source of the error. The code lines are prefixed with line numbers and the
error line marked with a fat arrow.

The return value is the formated context, followed by the original perl error
strings, or stringified exeception objects/messages:


  filename.pl 
  10  #code before 
  11  #code before 
  12=>#this line caused the error
  13  #code after
  14  #code after

  ... error... at filename.pl line 12 ...


In the first form (1), the C<$@> variable is implicitly used as the error. No
processing options can be supplied in this form.

In the second form (2), a single argument is supplied, which becomes the error
to process. No processing options can be supplied in this form.

In the third for (3), all options are provided as key value pairs. The required
key is B<error>, with a value corresponding to the error value.

Internally if the error is a simple perl string, the B<program> and B<line>
options are extracted from the error string. If the error is a reference, it is
expected to be an object responding to stringificaton, file, and line methods.
L<Exception::Base> and L<Exception::Class::Base>  provides this interface for
example.

B<Options include:>

=head4 program

  program => $path
  program => \$string

Manual override of the program source file. If the value is a normal scalar, it
is treated as a path. If it is a reference, it is treated as a reference to the
body of the program stored in a string.

=head4 line
    
    line=>value

Manual override of the line number within the program where the error occurred.

=head4 pre_lines

  pre_lines=>value

Specific the maximum lines of code to display before the error line. Default is
5.

=head4 post_lines

  post_lines=>value

Specific the maximum lines of code to display after the error line. Default is
5.

=head4 clean

  clean=>bool

When true, the normal perl error string is not included in the context
information, for a cleaner look.


=head3 Error::Show::tracer

  Error::show::tracer;                    (1)
  Error::show::tracer $error; (2)
	Error::Show::tracer option_pairs;       (3)


Repeatedly calls C<Error::Show::context> for each level the call stack
represented by a L<Devel::StackTrace> object extraced by the C<trace> call on
the error object.  Also see the trace option below.

If the error is simply a perl error string, this is equivilent to calling
C<Error::Show::Context> once.

Takes the same option pairs as L<Error::Show::context>.

It forces the B<clean> option for each level of stack trace. The stringified
error is appended at the end.


B<Additional Options:>

=head4 indent
  
    indent=>string

The string to use for each level of indent. Defaults to 4 spaces.

=head4 trace

  trace=>devel_stack_trace

Instead of specifying the error option, the trace option allows specifying
directly the L<Devel::StackTrace> object to use.

=head1 EXAMPLES

Please see the examples directory in this distribution

=head1 FUTURE WORK/TODO

=over 

=item Make usable from a Language Server?

=item Colour terminal output


=back

=head1 KNOWN ISSUES/GOTCHAS

Checking/running  programs via the -e and -E switches is not supported and will
die with an error message.

Only the first error in the perl error messages is used to find the context.
Hopefully it's the right one ;) 

=head1 DETAILS ON HOW IT WORKS

This module operates in two modes.

=head2
A summary of the command line syntax checking process:

=over 

=item 1. A new perl process is run to extract defauly @INC paths

This prints the paths back to the main script.

=item 2. @INC paths compared and B<-I> options identified

The difference between the main script C<@INC> and the information gathered
previously reveals the B<-I> options the user specified

=item 3. New perl process to execute Syntax checking

Another perl process, with the additional B<-I> arguments, and the
C<Error::Show::Internal> helper module is run in check mode

=item 4. Parsing of error information

The output is read in by the main process, with filenames, and line numbers
extracted from the first error string

=item 5. Building context

The filename parsed out from the error is slurped into an array of lines. Only
lines withing the configured range before and after the error line are kept.
This lines are are prepended and formatted with the line number. The proported
error line is also marked with a fat arrow to make it stand out

=item 6. Reporting

These lines are printed to STDERR, followed by the original perl error strings.


=back



=head1 SEE ALSO

L<Perl::Syntax> provides syntax checking from the command line. However it
doesn't show any errors by design (only interested in process return code)

L<Syntax::Check> provides programmatic syntax checking of files.

L<Perl::Critic> gives actual perl linting, but not great for syntax errors.

L<diagnostics>  and the C<splain> program give some very useful explanations
about the otherwise terse error strings normally output. It is part of the perl
distribution

=head1 AUTHOR

Ruben Westerberg, E<lt>drclaw@mac.comE<gt>

=head1 REPOSITORTY and BUGS

Please report any bugs via git hub:
L<http://github.com/drclaw1394/perl-error-show>

=head1 COPYRIGHT AND LICENSE

Copyright (C) 2022 by Ruben Westerberg

This library is free software; you can redistribute it and/or modify it under
the same terms as Perl or the MIT license.

=head1 DISCLAIMER OF WARRANTIES

THIS PACKAGE IS PROVIDED "AS IS" AND WITHOUT ANY EXPRESS
OR IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE
IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A
PARTICULAR PURPOSE.
=cut
